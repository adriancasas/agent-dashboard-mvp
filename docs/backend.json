{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the Agent Dashboard application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the User entity."
        },
        "email": {
          "type": "string",
          "description": "Email address of the user.",
          "format": "email"
        },
        "firstName": {
          "type": "string",
          "description": "First name of the user."
        },
        "lastName": {
          "type": "string",
          "description": "Last name of the user."
        }
      },
      "required": [
        "id",
        "email",
        "firstName",
        "lastName"
      ]
    },
    "Agent": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Agent",
      "type": "object",
      "description": "Represents an agent in the Agent Dashboard application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Agent entity."
        },
        "name": {
          "type": "string",
          "description": "Name of the agent."
        },
        "status": {
          "type": "string",
          "description": "Current status of the agent (active/inactive)."
        },
        "creditBalance": {
          "type": "number",
          "description": "Available credits for the agent."
        },
        "marketplaceId": {
          "type": "string",
          "description": "Identifier of the agent in the integrated marketplace."
        }
      },
      "required": [
        "id",
        "name",
        "status",
        "creditBalance",
        "marketplaceId"
      ]
    },
    "Project": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Project",
      "type": "object",
      "description": "Represents a project in the Agent Dashboard application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Project entity."
        },
        "name": {
          "type": "string",
          "description": "Name of the project."
        },
        "folderId": {
          "type": "string",
          "description": "Reference to Folder. (Relationship: Folder 1:N Project)"
        }
      },
      "required": [
        "id",
        "name",
        "folderId"
      ]
    },
    "Folder": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Folder",
      "type": "object",
      "description": "Represents a folder for organizing projects.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Folder entity."
        },
        "name": {
          "type": "string",
          "description": "Name of the folder."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Folder)"
        }
      },
      "required": [
        "id",
        "name",
        "userId"
      ]
    },
    "Alert": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Alert",
      "type": "object",
      "description": "Represents an alert or notification.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Alert entity."
        },
        "type": {
          "type": "string",
          "description": "Type of alert (e.g., agent status change, performance metric threshold)."
        },
        "message": {
          "type": "string",
          "description": "Message content of the alert."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Alert)"
        }
      },
      "required": [
        "id",
        "type",
        "message",
        "userId"
      ]
    },
    "Team": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Team",
      "type": "object",
      "description": "Represents a team of users that can share projects.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Team entity."
        },
        "name": {
          "type": "string",
          "description": "Name of the team."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Team - Creator)"
        },
        "memberIds": {
          "type": "array",
          "description": "References to Users. (Relationship: User N:N Team - Members)",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "name",
        "userId",
        "memberIds"
      ]
    },
    "ProjectAssignment": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "ProjectAssignment",
      "type": "object",
      "description": "Represents the assignment of agents to projects.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the ProjectAssignment entity."
        },
        "agentId": {
          "type": "string",
          "description": "Reference to Agent. (Relationship: Agent N:N Project)"
        },
        "projectId": {
          "type": "string",
          "description": "Reference to Project. (Relationship: Agent N:N Project)"
        }
      },
      "required": [
        "id",
        "agentId",
        "projectId"
      ]
    },
    "TeamProject": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "TeamProject",
      "type": "object",
      "description": "Represents the sharing of projects with teams.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the TeamProject entity."
        },
        "teamId": {
          "type": "string",
          "description": "Reference to Team. (Relationship: Team N:N Project)"
        },
        "projectId": {
          "type": "string",
          "description": "Reference to Project. (Relationship: Team N:N Project)"
        }
      },
      "required": [
        "id",
        "teamId",
        "projectId"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profile information. Path-based ownership ensures only the user can access their own profile.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/folders/{folderId}",
        "definition": {
          "entityName": "Folder",
          "schema": {
            "$ref": "#/backend/entities/Folder"
          },
          "description": "Stores folders created by a user for organizing projects. Path-based ownership ensures only the user can access their own folders.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "folderId",
              "description": "The unique identifier of the folder."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/folders/{folderId}/projects/{projectId}",
        "definition": {
          "entityName": "Project",
          "schema": {
            "$ref": "#/backend/entities/Project"
          },
          "description": "Stores projects organized within user-specific folders. Path-based ownership ensures only the user can access projects within their folders.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "folderId",
              "description": "The unique identifier of the folder."
            },
            {
              "name": "projectId",
              "description": "The unique identifier of the project."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/alerts/{alertId}",
        "definition": {
          "entityName": "Alert",
          "schema": {
            "$ref": "#/backend/entities/Alert"
          },
          "description": "Stores alerts and notifications for a specific user. Path-based ownership ensures only the user can access their own alerts.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "alertId",
              "description": "The unique identifier of the alert."
            }
          ]
        }
      },
      {
        "path": "/teams/{teamId}",
        "definition": {
          "entityName": "Team",
          "schema": {
            "$ref": "#/backend/entities/Team"
          },
          "description": "Stores team information, including the team owner (userId) and member IDs. The owner can manage the team, and members have specific access rights.",
          "params": [
            {
              "name": "teamId",
              "description": "The unique identifier of the team."
            }
          ]
        }
      },
      {
        "path": "/project_assignments/{projectAssignmentId}",
        "definition": {
          "entityName": "ProjectAssignment",
          "schema": {
            "$ref": "#/backend/entities/ProjectAssignment"
          },
          "description": "Represents the assignment of agents to projects. Allows querying for agents assigned to a specific project.",
          "params": [
            {
              "name": "projectAssignmentId",
              "description": "The unique identifier of the project assignment."
            }
          ]
        }
      },
      {
        "path": "/agents/{agentId}",
        "definition": {
          "entityName": "Agent",
          "schema": {
            "$ref": "#/backend/entities/Agent"
          },
          "description": "Stores agent data. Publicly accessible for viewing agent statuses and credits. Consider security implications for sensitive agent data.",
          "params": [
            {
              "name": "agentId",
              "description": "The unique identifier of the agent."
            }
          ]
        }
      },
      {
        "path": "/team_projects/{teamProjectId}",
        "definition": {
          "entityName": "TeamProject",
          "schema": {
            "$ref": "#/backend/entities/TeamProject"
          },
          "description": "Represents the sharing of projects with teams. Includes denormalized 'members' map for authorization independence.",
          "params": [
            {
              "name": "teamProjectId",
              "description": "The unique identifier of the Team Project."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore data structure is designed to support the Agent Dashboard application, focusing on secure access control, scalability, and maintainability. The design incorporates the following principles:\n\n1.  **Authorization Independence:**  To avoid hierarchical authorization dependencies (no `get()` calls in rules), authorization data is denormalized. For example, access to Projects via Teams requires the Team's member list to be denormalized (copied) into a membership map on the `team_projects` documents.\n2.  **Clarity of Intent:** The structure clearly defines the relationships between entities (User, Agent, Project, Folder, Alert, Team, ProjectAssignment, and TeamProject), making the authorization logic explicit. Standard naming conventions are used for fields like `userId`, `teamId`, `projectId` etc.\n3.  **DBAC (Database-Based Access Control):** Roles and memberships are managed directly in the database.\n4.  **QAPs (Rules are not Filters):**  The structure enables secure `list` operations. For example, listing projects accessible by a team is facilitated by the `team_projects` collection, which links teams to projects and includes denormalized team membership data. Similarly, listing agents assigned to a specific project involves the `project_assignments` collection.\n5.  **Invariants:** The structure facilitates the maintenance of data integrity regarding ownership and relationships. For example, each Folder and Alert is explicitly linked to a User via the `userId` field in each of their respective documents.\n\n**Denormalization Strategy:**\n\n*   The key denormalization strategy is applied to the `team_projects` collection.  When a Project is shared with a Team, the `memberIds` array from the `Team` document will be copied into a `members` map within the `team_projects` document. This enables security rules to verify team membership directly on the `team_projects` document without needing to `get()` the `Team` document. This is critical for atomic operations and scalability.\n\n**QAPs (Query Authorization Patterns) Support:**\n\n*   **List Projects for a User:** This is accomplished using the `/users/{userId}/folders/{folderId}/projects/{projectId}` structure. A user can only list projects under their folder.\n*   **List Agents for a Project:** This is achieved using the `/project_assignments/{projectAssignmentId}` collection. A query can be performed on `project_assignments` to list all assignments for a `projectId`.\n*   **List Projects for a Team:** The `team_projects` collection is used to store the project and team ID and provides a dedicated collection to list all projects for a given team. The security rules associated with this collection ensure only members of the team can access its contents, since the members map of the team is denormalized into each document."
  }
}